(function(c){var f=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var e=c.JConstraintMaxDistance;var a=c.JConstraintPoint;var g=function(u,r,x,C,l,o,i,I,k){this._body0=u;this._body1=r;this._hingeAxis=x.slice(0);this._hingePosRel0=C.slice(0);this._usingLimit=false;this._hingeEnabled=false;this._broken=false;this._damping=k;this._extraTorque=0;f.normalize(this._hingeAxis);var j=f.add(this._body0.get_currentState().position,f.subtract(this._hingePosRel0,this._body1.get_currentState().position));var q=f.add(this._hingePosRel0,d.getScaleVector(this._hingeAxis,l));var p=f.subtract(this._hingePosRel0,d.getScaleVector(this._hingeAxis,l));var F=f.add(j,d.getScaleVector(this._hingeAxis,l));var D=f.subtract(j,d.getScaleVector(this._hingeAxis,l));var t=1/20;var A=0.005;var m=I*l;this.sidePointConstraints=[];this.sidePointConstraints[0]=new e(this._body0,q,this._body1,F,m);this.sidePointConstraints[1]=new e(this._body0,p,this._body1,D,m);this.midPointConstraint=new a(this._body0,this._hingePosRel0,this._body1,j,A,t);if(o<=this.MAX_HINGE_ANGLE_LIMIT){var h=f.Y_AXIS;if(f.dotProduct(h,this._hingeAxis)>0.1){h[0]=1;h[1]=0;h[2]=0;}var w=f.crossProduct(this._hingeAxis,h);h=f.crossProduct(w,this._hingeAxis);f.normalize(h);var E=10*l;var B=d.getScaleVector(h,E);var H=0.5*(o-i);var z=B.slice(0);b.multiplyVector(b.getRotationMatrix(this._hingeAxis[0],this._hingeAxis[1],this._hingeAxis[2],-H),z);var v=0.5*(o+i);var s=E*2*Math.sin(0.5*v*Math.PI/180);var G=f.add(this._body1.get_currentState().position,this._hingePosRel0);var n=f.add(G,f.subtract(B,this._body0.get_currentState().position));var y=f.add(G,f.subtract(z,this._body1.get_currentState().position));this.maxDistanceConstraint=new e(this._body0,n,this._body1,y,s);this._usingLimit=true;}if(this._damping<=0){this._damping=-1;}else{this._damping=d.getLimiteNumber(this._damping,0,1);}this.enableHinge();};c.extend(g,c.PhysicsController);g.prototype.MAX_HINGE_ANGLE_LIMIT=150;g.prototype._hingeAxis=null;g.prototype._hingePosRel0=null;g.prototype._body0=null;g.prototype._body1=null;g.prototype._usingLimit=null;g.prototype._hingeEnabled=null;g.prototype._broken=null;g.prototype._damping=null;g.prototype._extraTorque=null;g.prototype.sidePointConstraints=null;g.prototype.midPointConstraint=null;g.prototype.maxDistanceConstraint=null;g.prototype.enableHinge=function(){if(this._hingeEnabled){return;}this.midPointConstraint.enableConstraint();this.sidePointConstraints[0].enableConstraint();this.sidePointConstraints[1].enableConstraint();if(this._usingLimit&&!this._broken){this.maxDistanceConstraint.enableConstraint();}this.enableController();this._hingeEnabled=true;};g.prototype.disableHinge=function(){if(!this._hingeEnabled){return;}this.midPointConstraint.disableConstraint();this.sidePointConstraints[0].disableConstraint();this.sidePointConstraints[1].disableConstraint();if(this._usingLimit&&!this._broken){this.maxDistanceConstraint.disableConstraint();}this.disableController();this._hingeEnabled=false;};g.prototype.breakHinge=function(){if(this._broken){return;}if(this._usingLimit){this.maxDistanceConstraint.disableConstraint();}this._broken=true;};g.prototype.mendHinge=function(){if(!this._broken){return;}if(this._usingLimit){this.maxDistanceConstraint.enableConstraint();}this._broken=false;};g.prototype.setExtraTorque=function(h){this._extraTorque=h;};g.prototype.getHingeEnabled=function(){return this._hingeEnabled;};g.prototype.isBroken=function(){return this._broken;};g.prototype.getHingePosRel0=function(){return this._hingePosRel0;};g.prototype.updateController=function(i){if(this._damping>0){var j=f.subtract(this._body1.get_currentState().rotVelocity,this._body0.get_currentState().rotVelocity);f.normalize(j);var o=f.dotProduct(this._body0.get_currentState().rotVelocity,j);var n=f.dotProduct(this._body1.get_currentState().rotVelocity,j);var l=0.5*(o+n);var h=1-this._damping;var q=l+(o-l)*h;var p=l+(n-l)*h;var m=f.add(this._body0.get_currentState().rotVelocity,d.getScaleVector(j,q-o));var k=f.add(this._body1.get_currentState().rotVelocity,d.getScaleVector(j,p-n));this._body0.setAngVel(m);this._body1.setAngVel(k);}if(this._extraTorque!=0){var r=this._hingeAxis.slice(0);b.multiplyVector(this._body0.get_currentState().get_orientation(),r);r=d.getScaleVector(r,this._extraTorque);this._body0.addWorldTorque(r);this._body1.addWorldTorque(d.getScaleVector(r,-1));}};c.HingeJoint=g;})(jigLib);