(function(e){var n=e.Vector3DUtil;var g=e.JMatrix3D;var a=e.JNumber3D;var o=e.JSegment;var i=e.JConfig;var h=e.PhysicsSystem;var b=Math,f=b.PI,d=b.min,j=b.max,l=b.cos,m=b.abs,k=b.sqrt;var c=function(p){this._car=p;};c.prototype.name=null;c.prototype.noslipVel=0.2;c.prototype.slipVel=0.4;c.prototype.slipFactor=0.7;c.prototype.smallVel=3;c.prototype._car=null;c.prototype._pos=null;c.prototype._axisUp=null;c.prototype._spring=null;c.prototype._travel=null;c.prototype._inertia=null;c.prototype._radius=null;c.prototype._sideFriction=null;c.prototype._fwdFriction=null;c.prototype._damping=null;c.prototype._numRays=null;c.prototype._angVel=null;c.prototype._steerAngle=null;c.prototype._torque=null;c.prototype._driveTorque=null;c.prototype._axisAngle=null;c.prototype._displacement=null;c.prototype._upSpeed=null;c.prototype._rotDamping=null;c.prototype._normalForce=null;c.prototype._locked=null;c.prototype._lastDisplacement=null;c.prototype._lastOnFloor=null;c.prototype._angVelForGrip=null;c.prototype.worldPos=null;c.prototype.worldAxis=null;c.prototype.wheelFwd=null;c.prototype.wheelUp=null;c.prototype.wheelLeft=null;c.prototype.wheelRayEnd=null;c.prototype.wheelRay=null;c.prototype.groundUp=null;c.prototype.groundLeft=null;c.prototype.groundFwd=null;c.prototype.wheelPointVel=null;c.prototype.rimVel=null;c.prototype.worldVel=null;c.prototype.wheelCentreVel=null;c.prototype._collSystem=null;c.prototype.setup=function(x,u,z,q,v,w,r,t,s,y,A,p){if(z==null){z=0;}if(q==null){q=0;}if(v==null){v=0;}if(w==null){w=0;}if(r==null){r=0;}if(t==null){t=0;}if(s==null){s=0;}if(y==null){y=0;}if(A==null){A=0;}if(p==null){p=0;}this._pos=x;this._axisUp=u;this._spring=z;this._travel=q;this._inertia=v;this._radius=w;this._sideFriction=r;this._fwdFriction=t;this._damping=s;this._numRays=y;this._drive=A;this._normalForce=p;this._torque=0;this.reset();};c.prototype.addTorque=function(p){this._driveTorque+=p;};c.prototype.setLock=function(p){this._locked=p;};c.prototype.setSteerAngle=function(p){this._steerAngle=p;};c.prototype.getSteerAngle=function(){return this._steerAngle;};c.prototype.getPos=function(){return this._pos;};c.prototype.getLocalAxisUp=function(){return this._axisUp;};c.prototype.getActualPos=function(){return n.add(this._pos,a.getScaleVector(this._axisUp,this._displacement));};c.prototype.getRadius=function(){return this._radius;};c.prototype.getDisplacement=function(){return this._displacement;};c.prototype.getAxisAngle=function(){return this._axisAngle;};c.prototype.getRollAngle=function(){return 0.1*this._angVel*180/f;};c.prototype.setRotationDamping=function(p){this._rotDamping=p;};c.prototype.getRotationDamping=function(){return this._rotDamping;};c.prototype.getOnFloor=function(){return this._lastOnFloor;};c.prototype.addForcesToCar=function(O){var q=[0,0,0,0];this._lastDisplacement=this._displacement;this._displacement=0;var X=this._car._chassis;worldPos=this._pos.slice(0);g.multiplyVector(X.get_currentState().get_orientation(),worldPos);worldPos=n.add(X.get_currentState().position,worldPos);worldAxis=this._axisUp.slice(0);g.multiplyVector(X.get_currentState().get_orientation(),worldAxis);wheelFwd=X.get_currentState().getOrientationCols()[2].slice(0);g.multiplyVector(g.getRotationMatrix(worldAxis[0],worldAxis[1],worldAxis[2],this._steerAngle/180*2*Math.PI),wheelFwd);wheelUp=worldAxis;wheelLeft=n.crossProduct(wheelUp,wheelFwd);n.normalize(wheelLeft);var W=2*this._radius+this._travel;wheelRayEnd=n.subtract(worldPos,a.getScaleVector(worldAxis,this._radius));wheelRay=new o(n.add(wheelRayEnd,a.getScaleVector(worldAxis,W)),a.getScaleVector(worldAxis,-W));if(this._collSystem==null){this._collSystem=h.getInstance().getCollisionSystem();}var U=10;var s=d(this._numRays,U);var w=[];var S=[];var A=(2*this._radius)/(s+1);var V=A;this._lastOnFloor=false;var y;var H;var C=0;var K=0;var p=null;for(K=0;K<s;K++){w[K]={};y=(V+K*A)-this._radius;H=this._radius*(1-l(90*(y/this._radius)*f/180));p=wheelRay.clone();p.origin=n.add(p.origin,n.add(a.getScaleVector(wheelFwd,y),a.getScaleVector(wheelUp,H)));if(this._collSystem.segmentIntersect(w[K],p,X)){this._lastOnFloor=true;if(w[K].fracOut<w[C].fracOut){C=K;}}S[K]=p;}if(!this._lastOnFloor){return false;}var u=w[C].fracOut;var N=w[C].posOut;var L=w[C].bodyOut;var Q=worldAxis.slice(0);if(s>1){for(K=0;K<s;K++){var F=w[K].fracOut;if(F<=1){Q=n.add(Q,a.getScaleVector(n.subtract(worldPos,S[K].getEnd()),1-F));}}n.normalize(Q);}else{Q=w[C].normalOut;}wheelFwd=n.crossProduct(wheelLeft,Q);this._displacement=W*(1-u);if(this._displacement<0){this._displacement=0;}var P=X.get_mass();var E=P/4;var r=L.get_friction();var J=X.getVelocity(this._pos);var x=this._displacement;if(this._displacement>this._travel){this._displacement=this._travel;var v=n.dotProduct(J,Q)/O*E;v=v*2*L.get_restitution()/10;z=a.getScaleVector(Q,-v);q=n.add(q,z);}z=a.getScaleVector(this._axisUp,this._spring*this._displacement+this._upSpeed*this._damping);q=n.add(q,z);groundUp=Q;groundLeft=n.crossProduct(Q,wheelFwd);n.normalize(groundLeft);groundFwd=n.crossProduct(groundLeft,groundUp);var R=a.getScaleVector(n.crossProduct(groundLeft,n.subtract(N,worldPos)),-this._angVel);var t=a.getScaleVector(groundFwd,n.dotProduct(J,groundFwd));var B=this._fwdFriction*r;var z=a.getScaleVector(n.subtract(R,t),E/O/this._radius*B);var G=n.get_length(z);if(G>this._normalForce*B){z=a.getScaleVector(z,this._normalForce*B/G);}q=n.add(q,z);this._torque-=n.dotProduct(n.subtract(R,t),groundFwd)/this._radius*E/O;this._angVelForGrip=n.dotProduct(J,groundFwd)/this._radius;var D=n.dotProduct(J,groundLeft);var B=this._sideFriction*r;var T=a.getScaleVector(groundLeft,-D*B);var z=a.getScaleVector(T,E/O/this._radius);var G=n.get_length(z);if(G>this._normalForce*B){z=a.getScaleVector(z,this._normalForce*B/G);}q=n.add(q,z);X.addWorldForce(q,N);if(L.get_movable()){var I=500;var M=I*L.get_mass();if(n.get_lengthSquared(q)>(M*M)){q=a.getScaleVector(q,M/n.get_length(q));}L.addWorldForce(a.getScaleVector(q,-1),N);}return true;};c.prototype.update=function(q){if(q<=0){return;}var p=this._angVel;this._upSpeed=(this._displacement-this._lastDisplacement)/j(q,a.NUM_TINY);if(this._locked){this._angVel=0;this._torque=0;}else{this._angVel+=(this._torque*q/this._inertia);this._torque=0;if(((p>this._angVelForGrip)&&(this._angVel<this._angVelForGrip))||((p<this._angVelForGrip)&&(this._angVel>this._angVelForGrip))){this._angVel=this._angVelForGrip;}this._angVel+=this._driveTorque*q/this._inertia*this._drive;this._driveTorque=0;if(this._angVel<-100){this._angVel=-100;}else{if(this._angVel>100){this._angVel=100;}}this._angVel*=this._rotDamping;this._axisAngle+=(this._angVel*q*180/f);}};c.prototype.reset=function(){this._angVel=0;this._steerAngle=0;this._torque=0;this._driveTorque=0;this._axisAngle=0;this._displacement=0;this._upSpeed=0;this._locked=false;this._lastDisplacement=0;this._lastOnFloor=false;this._angVelForGrip=0;this._rotDamping=0.99;};e.JWheel=c;})(jigLib);