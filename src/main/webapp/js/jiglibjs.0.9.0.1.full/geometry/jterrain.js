(function(a){var c=a.Vector3DUtil;var b=a.JNumber3D;var d=a.RigidBody;var e=function(f){this.Super(null);this._terrain=f;this.set_movable(false);this._type="TERRAIN";};a.extend(e,a.RigidBody);e.prototype._terrain=null;e.prototype.get_terrainMesh=function(){return this._terrain;};e.prototype.getHeightByIndex=function(g,f){g=this.limiteInt(g,0,_terrain.sw);f=this.limiteInt(f,0,_terrain.sh);return _terrain.heights[g][f];};e.prototype.getHeightAndNormalByPoint=function(t){var s=this.limiteInt(t[0],this._terrain.minW,this._terrain.maxW);var o=this.limiteInt(t[2],this._terrain.minH,this._terrain.maxH);var k=((s-_terrain.minW)/this._terrain.dw)|0;var f=((o-_terrain.minH)/this._terrain.dh)|0;k=this.limiteInt(k,0,this._terrain.sw);f=this.limiteInt(f,0,this._terrain.sh);var i=k+1;var u=f+1;i=this.limiteInt(i,0,this._terrain.sw);u=this.limiteInt(u,0,this._terrain.sh);var j=1-(s-(k*this._terrain.dw+this._terrain.minW))/this._terrain.dw;var g=(o-(f*this._terrain.dh+this._terrain.minH))/this._terrain.dh;j=b.getLimiteNumber(j,0,1);g=b.getLimiteNumber(g,0,1);var r=this._terrain.heights[k][f];var q=this._terrain.heights[k][u];var n=this._terrain.heights[i][f];var m=this._terrain.heights[i][u];var l={};l.height=0;l.normal=[0,0,0,0];var p;if(j<g||k==i||f==u){l.normal=c.crossProduct([0,m-n,this._terrain.dh,0],[this._terrain.dw,m-q,0,0]);c.normalize(l.normal);p=new PlaneData([(i*this._terrain.dw+this._terrain.minW),m,(u*this._terrain.dh+this._terrain.minH),0],l.normal);l.height=p.pointPlaneDistance(t);}else{l.normal=c.crossProduct([0,q-r,this._terrain.dh,0],[this._terrain.dw,n-r,0,0]);c.normalize(l.normal);p=new PlaneData([(k*this._terrain.dw+this._terrain.minW),r,(f*this._terrain.dh+this._terrain.minH),0],l.normal);l.height=p.pointPlaneDistance(t);}return l;};e.prototype.getHeightByPoint=function(f){return this.getHeightAndNormalByPoint(f).height;};e.prototype.getNormalByPoint=function(f){return this.getHeightAndNormalByPoint(f).normal;};e.prototype.getSurfacePosByPoint=function(f){return[f[0],this.getHeightAndNormalByPoint(f).height,f[2],0];};e.prototype.segmentIntersect=function(i,f,j){i.fracOut=0;i.posOut=[0,0,0,0];i.normalOut=[0,0,0,0];if(f.delta[1]>-b.NUM_TINY){return false;}var m=this.getHeightAndNormalByPoint(f.origin);if(m.height<0){return false;}var l=getHeightAndNormalByPoint(f.getEnd());if(l.height>0){return false;}var h=-l.height;var g=1/(b.NUM_TINY+m.height);var k=1/(b.NUM_TINY+l.height);c.scaleBy(m.normal,g);c.scaleBy(l.normal,k);i.normalOut=c.add(m.normal,l.normal);c.scaleBy(i.normalOut,1/(g+k));i.fracOut=m.height/(m.height+h+b.NUM_TINY);i.posOut=f.getPoint(i.fracOut);return true;};e.prototype.limiteInt=function(g,h,f){var i=g;if(i<h){i=h;}else{if(i>f){i=f;}}return i;};a.JTerrain=e;})(jigLib);