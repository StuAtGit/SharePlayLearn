(function(d){var m=d.Vector3DUtil;var b=d.JNumber3D;var f=d.JMatrix3D;var i=d.JConstraint;var o=d.JSegment;var g=d.JConfig;var h=d.JSphere;var c=d.MaterialProperties;var a=d.PhysicsState;var e=d.EdgeData;var j=d.SpanData;var k=d.CollPointInfo;var n=d.CollisionInfo;var l=function(){this.name="BoxBox";this.type0="BOX";this.type1="BOX";};d.extend(l,d.CollDetectFunctor);l.prototype.combinationDist=null;l.prototype.disjoint=function(u,r,x,w){var t=x.getSpan(r);var s=w.getSpan(r);var p=t.min;var v=t.max;var y=s.min;var q=s.max;var z=Math.min;if(p>(q+g.collToll+b.NUM_TINY)||y>(v+g.collToll+b.NUM_TINY)){u.flag=true;return true;}if((v>q)&&(y>p)){u.depth=z(v-y,q-p);}else{if((q>v)&&(p>y)){u.depth=z(q-p,v-y);}else{u.depth=(v<q)?v:q;u.depth-=(p>y)?p:y;}}u.flag=false;return false;};l.prototype.addPoint=function(t,s,p){for(var r=0,q=t.length;r<q;r++){var u=t[r];if(m.get_lengthSquared(m.subtract(u,s))<p){u=b.getDivideVector(m.add(u,s),2);return false;}}t.push(s);return true;};l.prototype.getSupportPoint=function(v,t){var r=v.get_currentState().getOrientationCols();var u=m.dotProduct(t,r[0]);var q=m.dotProduct(t,r[1]);var x=m.dotProduct(t,r[2]);var w=v.get_currentState().position.slice(0);var s=v.get_sideLengths();if(u<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[0],0.5*s[0]));}else{if(u>=b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[0],0.5*s[0]));}}if(q<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[1],0.5*s[1]));}else{if(q>b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[1],0.5*s[1]));}}if(x<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[2],0.5*s[2]));}else{if(x>b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[2],0.5*s[2]));}}return w;};l.prototype.getAABox2EdgeIntersectionPoints=function(t,x,H,J,I){var E;var G;var w;var u;var p;var s=0;var C;var q=m.subtract(I,J);m.normalize(q);var F=[];var r=[];var y=J;var D=I;var A=q;var B=b.getScaleVector(x,0.5);for(var z=2;z>=0;z--){if(Math.abs(A[z])<0.1){continue;}E=(z+1)%3;G=(z+2)%3;r=[-B[z],B[z]];for(var v=1;v>=0;v--){w=y[z]-r[v];u=D[z]-r[v];p=-1;if(w*u<-b.NUM_TINY){p=-w/(u-w);}else{if(Math.abs(w)<b.NUM_TINY){p=0;}else{if(Math.abs(u)<b.NUM_TINY){p=1;}}}if(p>=0){C=m.add(b.getScaleVector(J,1-p),b.getScaleVector(I,p));F=C;if((F[E]>-B[E]-b.NUM_TINY)&&(F[E]<B[E]+b.NUM_TINY)&&(F[G]>-B[G]-b.NUM_TINY)&&(F[G]<B[G]+b.NUM_TINY)){C=C.splice(0);f.multiplyVector(H.get_orientation(),C);C=m.add(C,H.position);this.addPoint(t,C,combinationDist);if(++s==2){return s;}}}}}return s;};l.prototype.getBox2BoxEdgesIntersectionPoints=function(x,B,z,t){var y=0;var u;var C=(t)?B.get_currentState():B.get_oldState();var s=(t)?z.get_currentState():z.get_oldState();var q=z.getCornerPointsInBoxSpace(s,C);var A=z.get_edges();var r;var p;for(var w=0;w<A.length;w++){var v=A[w];r=q[v.ind0];p=q[v.ind1];y+=this.getAABox2EdgeIntersectionPoints(x,B.get_sideLengths(),C,r,p);if(y>=8){return y;}}return y;};l.prototype.getBoxBoxIntersectionPoints=function(s,q,p,r){this.getBox2BoxEdgesIntersectionPoints(s,q,p,r);this.getBox2BoxEdgesIntersectionPoints(s,p,q,r);return m.get_length(s);};l.prototype.collDetect=function(ac,D){var R=ac.body0;var P=ac.body1;if(!R.hitTestObject3D(P)){return;}if(g.aabbDetection&&!R.get_boundingBox().overlapTest(P.get_boundingBox())){return;}var aj=b.NUM_TINY;var v=b.NUM_HUGE;var z=R.get_currentState().getOrientationCols();var M=P.get_currentState().getOrientationCols();var U=[z[0],z[1],z[2],M[0],M[1],M[2],m.crossProduct(z[0],M[0]),m.crossProduct(z[1],M[0]),m.crossProduct(z[2],M[0]),m.crossProduct(z[0],M[1]),m.crossProduct(z[1],M[1]),m.crossProduct(z[2],M[1]),m.crossProduct(z[0],M[2]),m.crossProduct(z[1],M[2]),m.crossProduct(z[2],M[2])];var y;var ab=[];var Z=0;var A=U.length;for(Z=0;Z<A;Z++){var ad=ab[Z]=new j();ad.depth=v;y=m.get_lengthSquared(U[Z]);if(y<aj){continue;}var q=U[Z].slice(0);m.normalize(q);if(this.disjoint(ab[Z],q,R,P)){return;}}var I=v;var O=-1;A=U.length;for(Z=0;Z<A;Z++){y=m.get_lengthSquared(U[Z]);if(y<aj){continue;}if(ab[Z].depth<I){I=ab[Z].depth;O=Z;}}if(O==-1){return;}var w=U[O].splice(0);if(m.dotProduct(m.subtract(P.get_currentState().position,R.get_currentState().position),w)>0){w=b.getScaleVector(w,-1);}var ag=true;var aa=[];var S=R.get_sideLengths();var X=P.get_sideLengths();combinationDist=0.05*Math.min(Math.min(S[0],S[1],S[2]),Math.min(X[0],X[1],X[2]));combinationDist+=(g.collToll*3.464);combinationDist*=combinationDist;if(I>-b.NUM_TINY){this.getBoxBoxIntersectionPoints(aa,R,P,false);}if(aa.length==0){ag=false;this.getBoxBoxIntersectionPoints(aa,R,P,true);}var K=m.subtract(m.subtract(R.get_currentState().position,R.get_oldState().position),m.subtract(P.get_currentState().position,P.get_oldState().position));var p=m.dotProduct(K,w);var J=I+p;var F=[];switch(O){case 0:case 1:case 2:F=this.getSupportPoint(P,b.getScaleVector(w,-1));break;case 3:case 4:case 5:F=this.getSupportPoint(R,w);break;case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:Z=O-6;var T=(Z/3)|0;var Q=Z-T*3;var E=this.getSupportPoint(R,w);var C=this.getSupportPoint(P,b.getScaleVector(w,-1));var V=m.crossProduct(w,M[Q]);var L=m.dotProduct(V,C);var ae=m.dotProduct(z[T],V);if(Math.abs(ae)<b.NUM_TINY){return;}var W=(L-m.dotProduct(E,V))/ae;E=m.add(E,b.getScaleVector(z[T],W));F=m.add(E,b.getScaleVector(w,0.5*I));break;}var ai;if(aa.length>0){ai=[];var B=b.NUM_HUGE;var H=-b.NUM_HUGE;var r;var u;var af;var x;var s;for(var Y=0;Y<aa.length;Y++){s=aa[Y];r=m.get_length(m.subtract(s,F));if(r<B){B=r;}if(r>H){H=r;}}if(H<B+b.NUM_TINY){H=B+b.NUM_TINY;}Z=0;for(var Y=0;Y<aa.length;Y++){s=aa[Y];r=m.get_length(m.subtract(s,F));af=(r-B)/(H-B);u=(1-af)*J;x=new k();if(ag){x.r0=m.subtract(s,R.get_oldState().position);x.r1=m.subtract(s,P.get_oldState().position);}else{x.r0=m.subtract(s,R.get_currentState().position);x.r1=m.subtract(s,P.get_currentState().position);}x.initialPenetration=u;ai[Z++]=x;}}else{x=new k();x.r0=m.subtract(F,R.get_currentState().position);x.r1=m.subtract(F,P.get_currentState().position);x.initialPenetration=J;ai=[];ai[0]=x;}var ah=new n();ah.objInfo=ac;ah.dirToBody=w;ah.pointInfo=ai;var G=new c();G.set_restitution(Math.sqrt(R.get_material().get_restitution()*P.get_material().get_restitution()));G.set_friction(Math.sqrt(R.get_material().get_friction()*P.get_material().get_friction()));ah.mat=G;D.push(ah);ac.body0.collisions.push(ah);ac.body1.collisions.push(ah);};d.CollDetectBoxBox=l;})(jigLib);