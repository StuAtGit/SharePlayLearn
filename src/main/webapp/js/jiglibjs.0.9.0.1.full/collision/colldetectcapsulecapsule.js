(function(d){var j=d.Vector3DUtil;var e=d.JMatrix3D;var a=d.JNumber3D;var g=d.JConstraint;var f=d.JConfig;var h=d.JCapsule;var l=d.JSegment;var c=d.MaterialProperties;var m=d.RigidBody;var i=d.CollPointInfo;var k=d.CollisionInfo;var b=function(){this.name="CapsuleCapsule";this.type0="CAPSULE";this.type1="CAPSULE";};d.extend(b,d.CollDetectFunctor);b.prototype.collDetect=function(E,C){var H=E.body0;var G=E.body1;if(!H.hitTestObject3D(G)){return;}if(f.aabbDetection&&!H.get_boundingBox().overlapTest(G.get_boundingBox())){return;}var B=[];var u;var n=[0,0,0,0];var p=new l(H.getEndPos(H.get_oldState()),a.getScaleVector(H.get_oldState().getOrientationCols()[1],-j.get_length(H)));var y=new l(H.getEndPos(H.get_currentState()),a.getScaleVector(H.get_currentState().getOrientationCols()[1],-j.get_length(H)));var o=new l(G.getEndPos(G.get_oldState()),a.getScaleVector(G.get_oldState().getOrientationCols()[1],-j.get_length(G)));var x=new l(G.getEndPos(G.get_currentState()),a.getScaleVector(G.get_currentState().getOrientationCols()[1],-j.get_length(G)));var q=H.get_radius()+G.get_radius();var J={};var I=p.segmentSegmentDistanceSq(J,o);var v={};var t=y.segmentSegmentDistanceSq(J,x);if(Math.min(I,t)<Math.pow(q+f.collToll,2)){var s=p.getPoint(J.t0);var r=o.getPoint(J.t1);var F=j.subtract(s,r);var z=Math.sqrt(I);var K=q-z;if(z>a.NUM_TINY){F=a.getDivideVector(F,z);}else{F=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),F);}var w=j.add(r,a.getScaleVector(F,G.get_radius()-0.5*K));n=j.add(n,F);u=new i();u.r0=j.subtract(w,H.get_oldState().position);u.r1=j.subtract(w,G.get_oldState().position);u.initialPenetration=K;B.push(u);}p=new l(H.getBottomPos(H.get_oldState()),a.getScaleVector(H.get_oldState().getOrientationCols()[1],j.get_length(H)));y=new l(H.getBottomPos(H.get_currentState()),a.getScaleVector(H.get_currentState().getOrientationCols()[1],j.get_length(H)));o=new l(G.getBottomPos(G.get_oldState()),a.getScaleVector(G.get_oldState().getOrientationCols()[1],j.get_length(G)));x=new l(G.getBottomPos(G.get_currentState()),a.getScaleVector(G.get_currentState().getOrientationCols()[1],j.get_length(G)));J={};I=p.segmentSegmentDistanceSq(J,o);v={};t=y.segmentSegmentDistanceSq(J,x);if(Math.min(I,t)<Math.pow(q+f.collToll,2)){s=p.getPoint(J.t0);r=o.getPoint(J.t1);F=j.subtract(s,r);z=Math.sqrt(I);K=q-z;if(z>a.NUM_TINY){F=a.getDivideVector(F,z);}else{F=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),F);}w=j.add(r,a.getScaleVector(F,G.get_radius()-0.5*K));n=j.add(n,F);u=new i();u.r0=j.subtract(w,H.get_oldState().position);u.r1=j.subtract(w,G.get_oldState().position);u.initialPenetration=K;B.push(u);}if(B.length>0){j.normalize(n);var A=new k();A.objInfo=E;A.dirToBody=n;A.pointInfo=B;var D=new c();D.set_restitution(Math.sqrt(H.get_material().get_restitution()*G.get_material().get_restitution()));D.set_friction(Math.sqrt(H.get_material().get_friction()*G.get_material().get_friction()));A.mat=D;C.push(A);E.body0.collisions.push(A);E.body1.collisions.push(A);}};d.CollDetectCapsuleCapsule=b;})(jigLib);